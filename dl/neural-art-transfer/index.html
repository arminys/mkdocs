



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.4.0">
    
    
      
        <title>Artistic Neural Style Transfer - An Vuong</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.7fb6a6f0.css">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="An Vuong" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                An Vuong
              </span>
              <span class="md-header-nav__topic">
                Artistic Neural Style Transfer
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    An Vuong
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Machine Learning
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Machine Learning
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/about-ml/" title="About Machine Learning" class="md-nav__link">
      About Machine Learning
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Deep Learning
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Deep Learning
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../about-dl/" title="About Deep Learning" class="md-nav__link">
      About Deep Learning
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Artistic Neural Style Transfer
      </label>
    
    <a href="./" title="Artistic Neural Style Transfer" class="md-nav__link md-nav__link--active">
      Artistic Neural Style Transfer
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#examples" title="Examples" class="md-nav__link">
    Examples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-does-it-work" title="How does it work?" class="md-nav__link">
    How does it work?
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#content-cost" title="Content cost" class="md-nav__link">
    Content cost
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#style-cost" title="Style cost" class="md-nav__link">
    Style cost
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#total-cost" title="Total cost" class="md-nav__link">
    Total cost
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" title="Implementation" class="md-nav__link">
    Implementation
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../about/" title="About me" class="md-nav__link">
      About me
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#examples" title="Examples" class="md-nav__link">
    Examples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-does-it-work" title="How does it work?" class="md-nav__link">
    How does it work?
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#content-cost" title="Content cost" class="md-nav__link">
    Content cost
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#style-cost" title="Style cost" class="md-nav__link">
    Style cost
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#total-cost" title="Total cost" class="md-nav__link">
    Total cost
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" title="Implementation" class="md-nav__link">
    Implementation
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="artistic-neural-style-transfer">Artistic Neural Style Transfer</h1>
<p><em>Friday, Jan 12 2018, HCM</em></p>
<p><em>This post is my understanding from Coursera's Convolutional Neural Networks course, the implementation is what I've done as 
required assignment, minor modifications added for documenting purpose.</em></p>
<p>Artistic Neural Transfer is a very fun part of Deep Learning and has gained a respectable reputation during last several years.
The neural network will receive 2 input images, namely, content image and style image. As the names suggest, its corressponding output
will (hopely) be the content image "redrawn" in the style of style image.</p>
<h2 id="examples">Examples</h2>
<p>Here are 3 examples of what Artistic Neural Transfer can do. The left and middle image are respectively content and style inputs,
the output is shown on the right image.</p>
<p><img alt="Example 1" src="../neural_art/one.jpg" title="Example 1" />
<img alt="Example 2" src="../neural_art/two.jpg" title="Example 2" />
<img alt="Example 3" src="../neural_art/three.jpg" title="Example 3" /></p>
<h2 id="how-does-it-work">How does it work?</h2>
<p>Different from other neural networks, an ArtNN does not learn weights/parameters of neurons during its training time. Instead,
it makes use of a pretrained deep ConvNet, feed it 2 input images (content and style) then it will learn the pixel of the output image.</p>
<p>The conv layers are "frozen" at training time and input layer is allowed to change. In order to do this, we would like to define a new
cost function based on Content cost and Style cost.</p>
<p>Before moving on, let's denote content image as C, style image as S and output image as G (generated image)</p>
<h3 id="content-cost">Content cost</h3>
<p>Content cost is calculated at one layer of the ConvNet. Usually, this layer should be somewhere in the middle of the network (not too deep
or too shallow), let's say we've chosen layer <strong><em>i</em></strong> to calculate content cost. Then this cost is equal to the sum of square of difference of 
corresponding activation units of layer <strong><em>i</em></strong> with respect to C and G. Well, if that sounds like alien language, let's look at this formula:</p>
<p>
<script type="math/tex; mode=display">J_{content}(C,G) =  \frac{1}{4 \times n_H \times n_W \times n_C}\sum _{ \text{all entries}} (a^{(C)} - a^{(G)})^2 </script>
</p>
<p>Better right? <script type="math/tex">a^{(C)}</script> and <script type="math/tex">a^{(G)}</script> are the activation units of layer <strong><em>i</em></strong> when the input are C and G respectively.
<script type="math/tex">n_{H}</script>, <script type="math/tex">n_{W}</script> and <script type="math/tex">n_{C}</script> are correspondingly height, width and depth (channel) of the layer, they play as normalizing coefficients.</p>
<h3 id="style-cost">Style cost</h3>
<p>Style cost is a little bit trickier. In order for G to have the same "art style" of S, we make use an idea that if, at layer <strong><em>i</em></strong>, the correlations of
different channels of that layer filter when input are G and S, respectively, are similar. Let's look at the formula:</p>
<p>
<script type="math/tex; mode=display">J_{style}^{[l]}(S,G) = \frac{1}{4 \times {n_C}^2 \times (n_H \times n_W)^2} \sum _{i=1}^{n_C}\sum_{j=1}^{n_C}(G^{M(S)}_{ij} - G^{M(G)}_{ij})^2 </script>
</p>
<p>
<script type="math/tex">G^{M}</script> is the Gram matrix, I denote it as <script type="math/tex">G^{M}</script> instead of conventional <script type="math/tex">G</script> to avoid confusion with input image G. This Gram matrix <script type="math/tex">G^{M}</script>
calculate the correlation between diffent channels of a filter. The following figure (taken from Prof. Andrew Ng's Deep learning Coursera course) does a 
perfect visualization:</p>
<p><img alt="Correlation" src="../neural_art/NST_GM.png" title="Correlation" /></p>
<p>Note that <script type="math/tex">J_{style}^{[l]}(S,G)</script> is caculated on a specific layer <strong><em>l</em></strong>, since different layers in ConvNet learn different characteristics of the image,
we will want to calculate<script type="math/tex">J_{style}^{[l]}(S,G)</script> on several different layers, thus what layers to calculate <script type="math/tex">J_{style}^{[l]}(S,G)</script> is another hyperparameter.  </p>
<p>Also for each value of <script type="math/tex">J_{style}^{[l]}(S,G)</script> we may want to assign a weight to it, for example, the following code contains Style cost parameters in my implementation, 
first value is the layer name, second value is the weight of that layer style cost:</p>
<pre><code class="python">STYLE_LAYERS = [
    ('conv1_1', 0.125),
    ('conv2_1', 0.125),
    ('conv3_1', 0.125),
    ('conv3_4', 0.125),
    ('conv4_1', 0.125),
    ('conv5_1', 0.125),
    ('conv5_2', 0.125),
    ('conv5_4', 0.125),]
</code></pre>

<p>Then total Style cost would look like:</p>
<p>
<script type="math/tex; mode=display">J_{style}(S,G) = \sum_{l} \lambda^{[l]} J^{[l]}_{style}(S,G)</script>
where <script type="math/tex">\lambda</script> is the weight matrix of Style cost.</p>
<h3 id="total-cost">Total cost</h3>
<p>With both Content cost and Style cost in hands, the Total cost will just be the weighted sum of those two:
<script type="math/tex; mode=display">J(G) = \alpha J_{content}(C,G) + \beta J_{style}(S,G)</script>
</p>
<h2 id="implementation">Implementation</h2>
<p>With the well-defined cost function, the implementation is pretty straightforward in Python using tensorFlow.</p>
<p>In the implementation, a pretrained VGG19 very deep network is used.
<img alt="VGG 19" src="../neural_art/vgg19.jpg" title="VGG19 architecture" /></p>
<p>Whole project can be found at: <a href="https://drive.google.com/drive/folders/11OYzjbRf039qtW98Kk78T8vmijo-d-Q7?usp=sharing">ArtNeuralTransfer</a>. You can simply run it by the following command:</p>
<pre><code class="python">python neural-art.py content_image style_image
</code></pre>

<p>output image can be found in output folder, several example images are included, for example, to generate the first example shown above, the command should be:</p>
<pre><code class="python">python neural-art.py cat.jpg stone.jpg
</code></pre>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../about-dl/" title="About Deep Learning" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                About Deep Learning
              </span>
            </div>
          </a>
        
        
          <a href="../../about/" title="About me" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                About me
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.ce2ab4bf.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:"../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
    
      
    
  </body>
</html>