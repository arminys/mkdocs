<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Neural Art Transfer - An Vuong</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">An Vuong</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Home</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Machine Learning <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../ml/about-ml/">About Machine Learning</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Deep Learning <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../about-dl/">About Deep Learning</a>
</li>
                            
<li class="active">
    <a href="./">Neural Art Transfer</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../about/">About</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../about-dl/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../about/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#artistic-neural-transfer">Artistic Neural Transfer</a></li>
            <li><a href="#examples">Examples</a></li>
            <li><a href="#how-does-it-work">How does it work?</a></li>
            <li><a href="#implementation">Implementation</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="artistic-neural-transfer">Artistic Neural Transfer</h1>
<p><em>Friday, Jan 12 2018, HCM</em></p>
<p><em>This post is my understanding from Coursera's Convolutional Neural Networks course, the implementation is what I've done as 
required assignment, minor modifications added for documenting purpose.</em></p>
<p>Artistic Neural Transfer is a very fun part of Deep Learning and has gained a respectable reputation during last several years.
The neural network will receive 2 input images, namely, content image and style image. As the names suggest, its corressponding output
will (hopely) be the content image "redrawn" in the style of style image.</p>
<h2 id="examples">Examples</h2>
<p>Here are 3 examples of what Artistic Neural Transfer can do. The left and middle image are respectively content and style inputs,
the output is shown on the right image.</p>
<p><img alt="Example 1" src="../neural_art/one.jpg" title="Example 1" />
<img alt="Example 2" src="../neural_art/two.jpg" title="Example 2" />
<img alt="Example 3" src="../neural_art/three.jpg" title="Example 3" /></p>
<h2 id="how-does-it-work">How does it work?</h2>
<p>Different from other neural networks, an ArtNN does not learn weights/parameters of neurons during its training time. Instead,
it makes use of a pretrained deep ConvNet, feed it 2 input images (content and style) then it will learn the pixel of the output image.</p>
<p>The conv layers are "frozen" at training time and input layer is allowed to change. In order to do this, we would like to define a new
cost function based on Content cost and Style cost.</p>
<p>Before moving on, let's denote content image as C, style image as S and output image as G (generated image)</p>
<h3 id="content-cost">Content cost</h3>
<p>Content cost is calculated at one layer of the ConvNet. Usually, this layer should be somewhere in the middle of the network (not too deep
or too shallow), let's say we've chosen layer <strong><em>i</em></strong> to calculate content cost. Then this cost is equal to the sum of square of difference of 
corresponding activation units of layer <strong><em>i</em></strong> with respect to C and G. Well, if that sounds like alien language, let's look at this formula:</p>
<p>
<script type="math/tex; mode=display">J_{content}(C,G) =  \frac{1}{4 \times n_H \times n_W \times n_C}\sum _{ \text{all entries}} (a^{(C)} - a^{(G)})^2 </script>
</p>
<p>Better right? <script type="math/tex">a^{(C)}</script> and <script type="math/tex">a^{(G)}</script> are the activation units of layer <strong><em>i</em></strong> when the input are C and G respectively.
<script type="math/tex">n_{H}</script>, <script type="math/tex">n_{W}</script> and <script type="math/tex">n_{C}</script> are correspondingly height, width and depth (channel) of the layer, they play as normalizing coefficients.</p>
<h3 id="style-cost">Style cost</h3>
<p>Style cost is a little bit trickier. In order for G to have the same "art style" of S, we make use an idea that if, at layer <strong><em>i</em></strong>, the correlations of
different channels of that layer filter when input are G and S, respectively, are similar. Let's look at the formula:</p>
<p>
<script type="math/tex; mode=display">J_{style}^{[l]}(S,G) = \frac{1}{4 \times {n_C}^2 \times (n_H \times n_W)^2} \sum _{i=1}^{n_C}\sum_{j=1}^{n_C}(G^{M(S)}_{ij} - G^{M(G)}_{ij})^2 </script>
</p>
<p>
<script type="math/tex">G^{M}</script> is the Gram matrix, I denote it as <script type="math/tex">G^{M}</script> instead of conventional <script type="math/tex">G</script> to avoid confusion with input image G. This Gram matrix <script type="math/tex">G^{M}</script>
calculate the correlation between diffent channels of a filter. The following figure (take from Prof. Andrew Ng's Deep learning Coursera course) does a 
perfect visualization:</p>
<p><img alt="Correlation" src="../neural_art/NST_GM.png" title="Correlation" /></p>
<p>Note that <script type="math/tex">J_{style}^{[l]}(S,G)</script> is caculated on a specific layer <strong><em>l</em></strong>, since different layers in ConvNet learn different characteristics of the image,
we will want to calculate<script type="math/tex">J_{style}^{[l]}(S,G)</script> on several different layers, thus what layers to calculate <script type="math/tex">J_{style}^{[l]}(S,G)</script> is another hyperparameter.  </p>
<p>Also for each value of <script type="math/tex">J_{style}^{[l]}(S,G)</script> we may want to assign a weight to it, for example, the following code contains Style cost parameters in my implementation, 
first value is the layer name, second value is the weight of that layer style cost:</p>
<pre><code class="python">STYLE_LAYERS = [
    ('conv1_1', 0.125),
    ('conv2_1', 0.125),
    ('conv3_1', 0.125),
    ('conv3_4', 0.125),
    ('conv4_1', 0.125),
    ('conv5_1', 0.125),
    ('conv5_2', 0.125),
    ('conv5_4', 0.125),]
</code></pre>

<p>Then total Style cost would look like:</p>
<p>
<script type="math/tex; mode=display">J_{style}(S,G) = \sum_{l} \lambda^{[l]} J^{[l]}_{style}(S,G)</script>
where <script type="math/tex">\lambda</script> is the weight matrix of Style cost.</p>
<h3 id="total-cost">Total cost</h3>
<p>With both Content cost and Style cost in hands, the Total cost will just be the weighted sum of those two:
<script type="math/tex; mode=display">J(G) = \alpha J_{content}(C,G) + \beta J_{style}(S,G)</script>
</p>
<h2 id="implementation">Implementation</h2>
<p>With the well-defined cost function, the implementation is pretty straightforward in Python using tensorFlow.</p>
<p>In the implementation, a pretrained VGG19 very deep network is used.
<img alt="VGG 19" src="../neural_art/vgg19.jpg" title="VGG19 architecture" /></p>
<p>Whole project can be found at: <a href="https://drive.google.com/drive/folders/11OYzjbRf039qtW98Kk78T8vmijo-d-Q7?usp=sharing">ArtNeuralTransfer</a>. You can simply run it by the following command:</p>
<pre><code class="python">python neural-art.py content_image style_image
</code></pre>

<p>output image can be found in output folder, several example images are included, for example, to generate the first example shown above, the command should be:</p>
<pre><code class="python">python neural-art.py cat.jpg stone.jpg
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script src="../../js/base.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="../../search/require.js"></script>
        <script src="../../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
